
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<!-- TODO: remove/add legend tag based on if content is set or not to avoid border issues -->

<dom-module id="visingo-file-chooser">

  <style type="text/css">
    /* TODO: allow styling from outside easily via providing --fc-error-color etc */
    .hover {
      opacity: .7;
      border: 2px dotted black;
      background-color: #89C35C; /* broken light green */
    }

    .hidden {
      display: none;
    }

    #fsDropZone {   
      -moz-border-radius:10px;  
      border-radius: 10px;  
      -webkit-border-radius: 10px;
      border: 2px dotted #89C35C;
      text-align: center;
    }

    #wrap {
      margin-top: 8px;
      margin-bottom: 8px;
    }

    #errorMultiple {
      color: indianred;
      margin-bottom: 8px;
    }
  </style>
  
  <template>
    <fieldset id="fsDropZone">
      <legend>
        <content></content>
      </legend>
      <div id="wrap">
        Drop file<span>{{multiplesPlural}}</span> here or <label for="inputHiddenFiles"><paper-button id="btnSelectFiles" raised><iron-icon icon="file-upload"></iron-icon> Select file<span>{{multiplesPlural}}</span></paper-icon-button></label>
      </div>
      <div id="errorMultiple" class="hidden">Multiple files not allowed.</div>
      <input hidden type="file" id="inputHiddenFiles" on-change="handleFiles" multiple$="{{multiple}}">
    </fieldset>

    <div>
      Files:
      <ul>
      <template is="dom-repeat" items="{{files}}">
        <li>Name: <span>{{item.name}}</span> <iron-icon icon="cancel" title="Remove" on-click="_remove" itemname="{{item.name}}"></iron-icon></li>
      </template>
      </ul>
    </div>
  </template>

</dom-module>

<!-- Drop files here or btn[Select files] -->

<script>
  (function() {
    Polymer({
      is: 'visingo-file-chooser',
      
      properties: {      
        multiple: {
          type: Boolean,
          value: false
        },

        multiplesPlural: {
          type: String,
          value: '',
          computed: '_computeMultiplesPlural(multiple)'
        },

        files: {
          type: Array,
          value: []
        }
      },

      _computeMultiplesPlural: function(multiple) {
        return multiple ? 's' : '';
      },

      _remove: function(evt) {
        this.remove(evt.model.__data__.item);
      },
          
      remove: function(file) {
        if(file) {
          this.splice('files', this.files.indexOf(file), 1);
          
          if(this.files.length < 1)
            this.toggleClass('hidden', true, this.$.errorMultiple);
        }
      },

      removeAll: function() {
        this.set('files', []); // TODO: or this.splice? does this give us correct events
      },

      handleFiles: function(evt) {
        // evt.target.files when using dialog, evt.dataTransfer.files when drag'n'drop
        var files = evt.target.files || evt.dataTransfer.files;
        this.pushFiles(files);
      },

      pushFiles: function(files) {
        // Loop through the FileList 'files', add to current files
        // (why the looping construct works? see http://stackoverflow.com/questions/5313575/html5-filelist-and-jquerys-each#comment31961145_5313722)
        for (var i = 0, f; f = files[i]; i++) {
          if(this.multiple || this.files.length < 1) {
            this.push('files', f);
          }
          else {
            this.toggleClass('hidden', false, this.$.errorMultiple);
          }
        }
      },

      // called by Polymer
      ready: function() {
        var dz = this.$.fsDropZone;

        this.ondragover = function(evt) {
          evt.stopPropagation();
          evt.preventDefault();
          evt.dataTransfer.dropEffect = 'copy';
          this.toggleClass('hover', true, dz);
          return false;
        }
        
        this.ondragleave = function(evt) {
          this.toggleClass('hover', false, dz);
          return false;
        }
        
        this.ondrop = function(evt) {
          evt.stopPropagation();
          evt.preventDefault();
          this.toggleClass('hover', false, dz);
          this.handleFiles(evt);
        }
      }
    });
  })();

</script>



<dom-module id="visingo-visualizer-element">
  <template>
  <div id="visualizerContainer"></div>
  </template>
</dom-module>

<!-- TODO: Make an array of loaded elements, then display when needed.
           This way we don't import multiple times, and also settings
           stay the same in-between. -->

<script>
  (function() {
    Polymer({
      is: 'visingo-visualizer-element',
      
      properties: {      
        visualizer: {
          type: String, // TODO: should be Object, not String
          observer: '_visualizerChange'
        },

        visualizationType: {
          type: String,
          observer: '_onewayBindVisualizationType'
        },

        inputFiles: {
          type: Array,
          observer: '_onewayBindInputFiles'
        },

        _element: {
          type: Object
        }
      },

      // TODO add resizing etc.
      // TODO: we don't need to bind that much here, just pass arguments once
      //       except for controls, we should bind controls...
      //       maybe controls are loaded from a different file, to the toolbar

      
      _onewayBindVisualizationType: function(newVal, oldVal) {
        this._onewayBind('visualizationType');
      },

      _onewayBindInputFiles: function(newVal, oldVal) {
        this._onewayBind('inputFiles');
      },

      _onewayBind: function(prop) {
        if(typeof this._element !== 'undefined')
          this._element.input[prop] = this[prop];
      },

      // TODO visualizer should not change on the fly on this page!
      //      remove the possibility
      _visualizerChange: function(newVal, oldVal) {
        elem = Polymer.dom(this.$.container).firstChild;

        if(typeof elem !== 'undefined')
          Polymer.dom(this.$.container).removeChild(elem);

        this._element = undefined;

        this._import(this.visualizer);
      },

      _import: function(visualizer) {
        this.importHref( // TODO: should be visualizer.directory, not visualizer
          '../../visualizers/' + visualizer + '/element.html',
          function(evt) { //            TODO visualizer.name
            var elemName = 'visualizer-' + visualizer + '-element';
            var elem = document.createElement(elemName);
            elem.id = 'visualizerElement';
            elem.input = {}; //TODO initialize bindings if needed

            // TODO map properties forward to the element if needed
            Object.keys(this.properties).forEach(function(item, idx, arr) {
              // ignore properties starting with underscore, also visualizer
              if(item[0] !== '_' && item !== 'visualizer')
                elem.input[item] = this[item];
            }, this);

            Polymer.dom(this.$.visualizerContainer).appendChild(elem);
            this._element = elem;
          }.bind(this),
          function(evt) {
            // loading error
            alert('visualizer element could not be imported!'); // TODO: make it smarter
          }
        );
      },
    });

  })();

</script>

